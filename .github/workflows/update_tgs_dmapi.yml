name: Update TGS DMAPI

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-dmapi:
    name: Update the TGS DMAPI
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Prepare update branch
        run: |
          git fetch origin
          git checkout -B tgs-dmapi-update origin/master

      - name: Apply DMAPI update
        uses: tgstation/tgs-dmapi-updater@v2
        id: dmapi-update
        with:
          header-path: "code/__defines/tgs.dm"
          library-path: "code/modules/tgs"

      - name: Commit and Push changes (if any)
        run: |
          git config user.name "vorestation-ci[bot]"
          git config user.email "199609141+vorestation-ci[bot]@users.noreply.github.com"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
            exit 0
          fi
          git commit -m 'Update TGS DMAPI'
          git push -f -u origin tgs-dmapi-update

      - name: Generate GitHub App Token
        id: app-token-generation
        if: ${{ secrets.APP_ID && secrets.APP_PRIVATE_KEY }}
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      - name: Check for diff from master
        run: |
          git fetch origin
          if git diff --quiet origin/master...tgs-dmapi-update; then
            echo "No changes to open a PR for. Exiting."
            exit 0
          fi

      - name: Create pull request with app token
        if: ${{ steps.app-token-generation.outputs.token != '' }}
        env:
          GH_TOKEN: ${{ steps.app-token-generation.outputs.token }}
        run: |
          gh pr create \
            --base master \
            --head tgs-dmapi-update \
            --title "Automatic TGS DMAPI Update" \
            --body "This pull request updates the TGS DMAPI to the latest version.

Please note any changes that may be breaking or unimplemented in your codebase by checking what changes are in the definitions file: \`code/__DEFINES/tgs.dm\` before merging.

${{ steps.dmapi-update.outputs.release-notes }}" \
            --label "Tools"

      - name: Create pull request with default token
        if: ${{ steps.app-token-generation.outputs.token == '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --base master \
            --head tgs-dmapi-update \
            --title "Automatic TGS DMAPI Update" \
            --body "This pull request updates the TGS DMAPI to the latest version.

Please note any changes that may be breaking or unimplemented in your codebase by checking what changes are in the definitions file: \`code/__DEFINES/tgs.dm\` before merging.

${{ steps.dmapi-update.outputs.release-notes }}" \
            --label "Tools"
